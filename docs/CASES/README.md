<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=103580753', 'ym');

    ym(103580753, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/103580753" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
# –†–µ–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —Ä–∞–±–æ—Ç–µ


## –ö–ï–ô–° - –í–∏—Ç—Ä–∏–Ω–∞ –¥–∞–Ω–Ω—ã—Ö

**–í–∏—Ç—Ä–∏–Ω–∞ –¥–∞–Ω–Ω—ã—Ö** ‚Äì —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–∞–±–ª–∏—á–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ —Å—Ç–æ —Ä–∞–∑ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–∞, –≥–¥–µ-—Ç–æ –æ—á–∏—â–µ–Ω–∞ –æ—Ç –ª–∏—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ù–æ —É –≤–∏—Ç—Ä–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏. –ù–∞–ø—Ä–∏–º–µ—Ä, —É –º–µ–Ω—è –≤–∏—Ç—Ä–∏–Ω–∞ —Å–æ–±–∏—Ä–∞–ª–∞—Å—å –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ –¥–µ–±–µ—Ç–æ–≤—ã–º –∫–∞—Ä—Ç–∞–º, –∫—Ä–µ–¥–∏—Ç–Ω—ã–º –∫–∞—Ä—Ç–∞–º, –∏–ø–æ—Ç–µ–∫–∞–º, –≤–∫–ª–∞–¥–∞–º –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ. –†–µ–∞–ª—å–Ω–æ –º–Ω–æ–≥–æ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤-—Ç–∞–±–ª–∏—Ü. –ö–∞–∂–¥—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç —É —Å–µ–±—è –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–Ω–æ–µ –≤—Ä–µ–º—è. –£ –∫–æ–≥–æ-—Ç–æ –¥–∞–Ω–Ω—ã–µ –≥–æ—Ç–æ–≤—ã –∑–∞ –≤—á–µ—Ä–∞, –∞ –≥–¥–µ-—Ç–æ —Ç–æ–ª—å–∫–æ –∑–∞ –ø–æ–∑–∞–≤—á–µ—Ä–∞. 

–ü–æ—ç—Ç–æ–º—É –µ—Å–ª–∏ –º—ã –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å —Ä–∞—Å—á–µ—Ç –≤–∏—Ç—Ä–∏–Ω—ã —Å –æ–¥–Ω–æ–π –¥–∞—Ç–æ–π –∑–∞ –≤—á–µ—Ä–∞ (–¢-1), —Ç–æ –ø–æ –∫–∞–∫–∏–º-—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º –º—ã –ø—Ä–æ—á–∏—Ç–∞–µ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ, –∞ –ø–æ –∫–∞–∫–∏–º-—Ç–æ –±—É–¥–µ—Ç 0 —Å—Ç—Ä–æ–∫ (–¥–∞–Ω–Ω—ã–µ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏—Å—å). –ß–µ –¥–µ–ª–∞—Ç—å?

–Ø –Ω–∞—á–∞–ª –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–∞–∂–¥–æ–º—É –ø—Ä–æ–¥—É–∫—Ç—É –≤–æ –≤—Ä–µ–º—è —Ä–∞—Å—á–µ—Ç–∞ –≤–∏—Ç—Ä–∏–Ω—ã. –ò –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ, –º–æ–π —Å–∫—Ä–∏–ø—Ç —Ö–æ–¥–∏—Ç –≤ —Ç–∞–±–ª–∏—Ü—É —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –∏ —á–∏—Ç–∞–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ (–∫–∞—Ä—Ç—ã, –∫—Ä–µ–¥–∏—Ç—ã, –≤–∫–ª–∞–¥—ã –∏ —Ç.–¥.) —Å–≤–æ—é –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É.

| –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞     | –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã |
|-----------------------|---------------|
| –î–µ–±–µ—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã       | 2024-11-10    |
| –ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã       | 2024-11-11    |
| –ò–ø–æ—Ç–µ–∫–∞               | 2024-11-15    |
| –í–∫–ª–∞–¥—ã                | 2024-11-11    |
| –ü–µ—Ä–µ–≤–æ–¥—ã –°–ù–ì         | 2024-11-18    |


–û—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ –∏—Å–∫–∞—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –≤ —Ç–∞–∫–æ–π —Ç–∞–±–ª–∏—Ü–µ —ç—Ç–æ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ. –ù—É –≤–æ—Ç –º—ã –≤–∏–¥–∏–º, —á—Ç–æ –ø–æ –¥–µ–±–µ—Ç–æ–≤—ã–º –∫–∞—Ä—Ç–∞–º –∫—Ä–∞–π–Ω—è—è –¥–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ 2024-11-10. –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –¥–∞–Ω–Ω—ã–µ –Ω–∞—á–Ω—É—Ç –≥—Ä—É–∑–∏—Ç—å—Å—è –∑–∞ 11 –Ω–æ—è–±—Ä—è. –ê –ø–æ –ò–ø–æ—Ç–µ–∫–µ —É–∂–µ —Å 16 –Ω–æ—è–±—Ä—è. –ü—Ä–∏ —ç—Ç–æ–º –¥–∞—Ç–∞, –¥–æ –∫–æ—Ç–æ—Ä–æ–π —Å–∫—Ä–∏–ø—Ç—É –Ω–∞–¥–æ –≥—Ä—É–∑–∏—Ç—å—Å—è —Ç–æ–∂–µ –Ω–µ —Å –Ω–µ–±–∞ –±–µ—Ä–µ—Ç—Å—è. –Ø —Ç–∞–∫–∂–µ —á–∏—Ç–∞—é –¥–∞—Ç—É –∑–∞–≥—Ä—É–∑–∫–∏ —É —Å–∞–º–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞. –ò –¥–µ–ª–∞—é —ç—Ç–æ –Ω–µ –≤ –ª–æ–±. –ù—É –∏—Å—Ç–æ—á–Ω–∏–∫ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–µ—Ä–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ 10 –ª–µ—Ç –∏ —Ç–∞–º —Å–æ—Ç–Ω–∏ –¢–µ—Ä—Ä–∞–±–∞–π—Ç –¥–∞–Ω–Ω—ã—Ö. –î–µ–ª–∞—é —ç—Ç–æ —á–µ—Ä–µ–∑ —á—Ç–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –æ –ø–∞—Ä—Ç–∏—Ü–∏—è—Ö:

```python
source_table = spark.sql(f'SHOW PARTITIONS {TABLE}')\
                            .select(F.regexp_extract("partition", f"date_event=(.*)", 1).alias("date"))\
                            .select(F.max("date").alias("max_date"))
                            .first()["max_date"]
```

–ú–æ–∂–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å, —á—Ç–æ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–æ –í–∫–ª–∞–¥–∞–º —Å–¥–æ—Ö –∏ —Ç–∞–±–ª–∏—Ü–∞ —Å –≤–∫–ª–∞–¥–∞–º–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–º–µ–µ—Ç. –ß–µ—Ä–µ–∑ –º–µ—Å—è—Ü –µ–µ –ø–æ—á–∏–Ω—è—Ç –∏ –Ω–∞—à —Å–∫—Ä–∏–ø—Ç –Ω–∞—á–Ω–µ—Ç —Å —Ç–æ–π –¥–∞—Ç—ã, –∫–æ—Ç–æ—Ä–∞—è –±—ã–ª–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤ –≤–∏—Ç—Ä–∏–Ω–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–∏ —ç—Ç–æ–º –¥—Ä—É–≥–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –Ω–∏–∫–∞–∫ –Ω–µ –ø–æ—Å—Ç—Ä–∞–¥–∞—é—Ç. 

***
## –ö–ï–ô–° - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ dbt

–ö–æ –º–Ω–µ –ø—Ä–∏—à–ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏. –£ –Ω–∏—Ö –±—ã–ª–æ —Ç—Ä–∏ SQL —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª–∏–Ω–æ–π –≤ 500-800 —Å—Ç—Ä–æ–∫. –í —ç—Ç–∏—Ö SQL –±—ã–ª–æ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π CASE WHEN –∏ –¥–∞–ª—å—à–µ –∫–∞–∫–æ–µ-—Ç–æ —É—Å–ª–æ–≤–∏–µ, —Ç–∏–ø–∞
```sql
SELECT
    CASE 
        WHEN URL LIKE '%business%' THEN 'camp_business'
        WHEN URL LIKE '%business1%' THEN 'camp_business1'
        WHEN URL LIKE '%business2%' THEN 'camp_business2'
        ... (500 —É—Å–ª–æ–≤–∏–π)
        ELSE 'NO'
    END
FROM TABLE
```
–£ –Ω–∏—Ö —ç—Ç–æ –≤—Å–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –±—ã–ª–æ —á–∏—Ç–∞—Ç—å, —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç—å, –¥–∞ –∏ –æ–Ω–∏ —Ç–∞–º –ø–æ—Ç–æ–º –µ—â–µ –¥–µ–ª–∞–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ UNION –∏ –æ–Ω –ø–∞–¥–∞–ª, –∫–æ–≥–¥–∞ —ç—Ç–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –∏ –Ω–µ –¥–µ–ª–∞—Ç—å. –ù—É –ø—Ä–æ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–æ–º –±—ã–ª–∏ –Ω–∞–ø–∏—Å–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã. 
–Ø –≤–∑—è–ª dbt –∏ –Ω–∞–ø–∏—Å–∞–ª –º–æ–¥–µ–ª—å–∫—É —Ç–∏–ø–∞:
```sql
{{ config(
    materialized='incremental',
    engine='ReplicatedMergeTree',
    tags=['etea']
) }}


# Read dbt_marks
{% set sql %}
    select * from {{ ref('dbt_marks') }}
{% endset %}
{% set res = run_query(sql) %}



{% set exec_date = var('execution_date')|string %}
{{ log("exec_date: " ~ exec_date, True) }}



# Save to condition_list, result_list
{% if execute %}

    {% set condition_list = res.columns[0].values() %}
    {% set result_list = res.columns[1].values() %}

{% else %}

    {% set results_list = [] %}

{% endif %}



{% for condition, result in zip(condition_list, result_list) %}
    SELECT
        dateTime,
        CASE
            WHEN {{ condition }} THEN {{ result }}
            ELSE 'undefined'
        END as URL,
        counterUserIDHash,
        isPageView
    FROM {{ source('schema', 'your_table') }}
    WHERE dateTime::DATE = '{{ exec_date }}'
    AND isPageView = '1'
    AND URL not like '%stage%'
    {% if not loop.last %}
        union all
    {% endif %}
{% endfor %}
```
–¢—É—Ç –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –º–Ω–æ–≥–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ–≥–æ, –Ω–æ –ø—Ä–∏—Å–º–æ—Ç—Ä–∏—Ç–µ—Å—å –∫ –≥–ª–∞–≤–Ω–æ–º—É SQL —Å–∫—Ä–∏–ø—Ç—É. –¢–∞–º –≤–∏–¥–Ω–æ, —á—Ç–æ –≤ —É—Å–ª–æ–≤–∏—è CASE WHEN –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –Ω–µ–∫–∏–π —à–∞–±–ª–æ–Ω. –£ –º–µ–Ω—è –µ—Å—Ç—å —Ü–∏–∫–ª, –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è SQL –∑–∞–ø—Ä–æ—Å —Å –û–î–ù–ò–ú CASE WHEN. –í —ç—Ç–æ–º —Ü–∏–∫–ª–µ –≤ —É—Å–ª–æ–≤–∏—è –ø–æ–æ—á–µ—Ä–µ–¥–Ω–æ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è. –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –±–µ—Ä—É—Ç—Å—è –∏–∑ –æ–±—ã—á–Ω–æ–≥–æ txt —Ñ–∞–π–ª–∏–∫–∞. 

–í–æ—Ç —Ç–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç —Ñ–∞–π–ª–∏–∫:
```
condition,result
URL like '%business/ecom/smm%','smm'
URL like '%business/ecom/all%','all'
URL like '%business/nbs/insales%','insales'
...
```

–ò —Ç–µ–ø–µ—Ä—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –º–æ–≥—É—Ç –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–∫–æ–ª—å–∫–æ —É–≥–æ–¥–Ω–æ —Å–≤–æ–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –≤ —ç—Ç–æ—Ç —Ñ–∞–π–ª–∏–∫, –∞ dbt –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–∏—Ç–∞—Ç—å –æ—Ç—Ç—É–¥–∞ –≤—Å–µ —Å—Ç—Ä–æ—á–∫–∏ –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å –≤ –∑–∞–ø—Ä–æ—Å –∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –µ–≥–æ!

–ò —Ç–µ–ø–µ—Ä—å –≤–º–µ—Å—Ç–æ 800 —Å—Ç—Ä–æ–∫ SQL –∫–æ–¥–∞ —É –Ω–∞—Å –µ—Å—Ç—å –ø—Ä–æ—Å—Ç–æ–π SQL –∑–∞–ø—Ä–æ—Å –∏ txt —Ñ–∞–π–ª–∏–∫.

***
## –ö–ï–ô–° - –ò–∑ —Å—Ç–∞—Ä–æ–≥–æ Greenplum –≤ –Ω–æ–≤—ã–π Greenplum

–ë—ã–ª–∞ —Å–∏—Ç—É–∞—Ü–∏—è - –±—ã–ª —Å—Ç–∞—Ä—ã–π –∫–ª–∞—Å—Ç–µ—Ä Greenplum. –í –Ω–µ–º –±—ã–ª–∏ —Ç–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–¥–æ –±—ã–ª–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –Ω–æ–≤—ã–π Greenplum. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –º–æ–∂–Ω–æ —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏.

–í–æ—Ç –ø–µ—Ä–≤—ã–π —Å–ø–æ—Å–æ–± –≤ –ª–æ–±:
–ë–µ—Ä–µ–º Apache Spark, –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ jdbc –∫ –ì—Ä–∏–Ω–ø–ª–∞–º—É, –ø–∏—à–µ–º –∑–∞–ø—Ä–æ—Å –∏ —á–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ. –ù–û! –í —Å–ª—É—á–∞–µ —á—Ç–µ–Ω–∏—è –°–ø–∞—Ä–∫–æ–º —á–µ—Ä–µ–∑ JDBC —É –Ω–∞—Å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ª—å—é—Ç—Å—è —á–µ—Ä–µ–∑ –º–∞—Å—Ç–µ—Ä-—Ö–æ—Å—Ç. –¢–æ —Å–∞–º–æ–µ –±—É—Ç—ã–ª–æ—á–Ω–æ–µ –≥–æ—Ä–ª—ã—à–∫–æ. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±–º–∞–Ω—É—Ç—å –≤—Å–µ—Ö –∏ —á–∏—Ç–∞—Ç—å –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ —Å –∫–∞–∂–¥–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ Greenplum. –ù–∞–ø—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä WHERE gp_segment_id = 0(1, 2, 3, 4 –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ). –¢–æ–≥–¥–∞ –º—ã —Å–∏–ª—å–Ω–æ —Ä–∞–∑–≥—Ä—É–∑–∏–º –º–∞—Ç—Å–µ—Ä—Ö–æ—Å—Ç.

–í—Ç–æ—Ä–æ–π –≤–∞—Ä–∏–∞–Ω—Ç —á–µ—Ä–µ–∑ –≥—Ä–∏–Ω–ø–ª–∞–º –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä:
–í–æ—Ç —Ç—É—Ç —É–∂–µ –º–æ–∂–Ω–æ —á–∏—Ç–∞—Ç—å –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å —Ä–∞–∑–Ω—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –ù–µ—Ç —Ç–æ–≥–æ —Å–∞–º–æ–≥–æ –±—É—Ç—ã–ª–æ—á–Ω–æ–≥–æ –≥–æ—Ä–ª—ã—à–∫–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –ì–ü. –ù–æ –ø—Ä–∏ —Ç–∞–∫–æ–º –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–µ —É –º–µ–Ω—è —á–∏—Ç–∞–ª–∞—Å—å –≤—Å—è —Ç–∞–±–ª–∏—Ü–∞ —Ü–µ–ª–∏–∫–æ–º —Ç–∏–ø–∞ ```SELECT * FROM TABLE```. –ù–µ –≤–∞—Ä–∏–∞–Ω—Ç. –Ø –Ω–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç, –∫–∞–∫ –∑–∞–¥–∞–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å, –∏—Å–ø–æ–ª—å–∑—É—è —ç—Ç–æ—Ç –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä. –ò–¥–µ–º –¥–∞–ª—å—à–µ.

–¢—Ä–µ—Ç–∏–π –≤–∞—Ä–∏–∞–Ω—Ç —á–µ—Ä–µ–∑ EXTERNAL TABLE:
–í —Å–∞–º–æ–º Dbeaver –≤ Greenplum —Å–æ–∑–¥–∞–µ–º –≤–Ω–µ—à–Ω—é—é —Ç–∞–±–ª–∏—Ü—É –≤ S3 —Å –ø–æ–º–æ—â—å—é PXF. –ö–æ—Ä–æ—á–µ –≤ –≥—Ä–∏–Ω–ø–ª–∞–º —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ç–∏–ø–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–∞–Ω–Ω—ã–µ –≤ S3 (–ø—Ä—è–º —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—É—Ç—å –¥–æ –ø–∞–ø–∫–∏). –ó–∞–ø—Ä–æ—Å –ø–∏—à–µ–º –≤ –ì–ü, –∞ –¥–∞–Ω–Ω—ã–µ –ª–µ–∂–∞—Ç –≤ S3. –ù–æ –ø—Ä–∏ —ç—Ç–æ–º —á—Ç–µ–Ω–∏–µ –≤—Å–µ, –∫–∞–∫ –±—É–¥—Ç–æ –ø–æ–ª—å–∑—É–µ–º—Å—è –æ–±—ã—á–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π. –°—É–ø–µ—Ä! –ó–Ω–∞—á–∏—Ç –≤ —Å—Ç–∞—Ä–æ–º –ì—Ä–∏–Ω–ø–ª–∞–º–µ —Å–æ–∑–¥–∞–µ–º –≤–Ω–µ—à–Ω—é—é —Ç–∞–±–ª–∏—Ü—É –≤ S3. –ò –≤ –Ω–æ–≤–æ–º –ì—Ä–∏–Ω–ø–ª–∞–º–µ —Å–æ–∑–¥–∞–µ–º –≤–Ω–µ—à–Ω—é—é —Ç–∞–±–ª–∏—Ü—É –≤ S3 –Ω–∞ —Ç—É –∂–µ –ø–∞–ø–∫—É! –¢.–µ. —É –Ω–∞—Å –¥–≤–∞ –ì–ü —á–∏—Ç–∞—é—Ç –∏–∑ –æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞.

**–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–π —Ç–∞–±–ª–∏—Ü—ã –≤ Greenplum**.
–ü—Ä–∏ —ç—Ç–æ–º –¥–∞–Ω–Ω—ã–µ —Å–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ S3 –∏ –∏—Ö –º–æ–∂–Ω–æ –ø—Ä—è–º –ø–æ—Ç—Ä–æ–≥–∞—Ç—å

**–ó–∞–ø–∏—Å—å –∏–∑ Greenplum –≤ S3**
```sql
Drop EXTERNAL TABLE if exists pxf_write_paqruet_s3;
CREATE WRITABLE EXTERNAL TABLE pxf_write_paqruet_s3 (
 visit_id text,
 body text,
 meta__checkpoint text
)
LOCATION ('pxf://data-lake/test/?PROFILE=s3:parquet&accesskey=***&secretkey=***&endpoint=https://storage.yandexcloud.net')
FORMAT 'CUSTOM' (FORMATTER='pxfwritable_export');
INSERT into pxf_write_paqruet_s3
select *
from stg2.table
where meta__checkpoint = '2024-10-01';
```

**–ß—Ç–µ–Ω–∏–µ –∏–∑ S3 –≤ Greenplum**
```sql
Drop EXTERNAL TABLE if exists pxf_read_paqruet_s3;
CREATE READABLE EXTERNAL TABLE pxf_read_paqruet_s3 (
 visit_id text,
 body text,
 meta__checkpoint text
)
LOCATION ('pxf://data-lake/test/?PROFILE=s3:parquet&accesskey=***&secretkey=***&endpoint=https://storage.yandexcloud.net')
FORMAT 'CUSTOM' (FORMATTER='pxfwritable_import');

select *
from pxf_read_paqruet_s3;
```

–°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ –≤ –Ω–æ–≤–æ–º –ì–ü –º—ã –¥–µ–ª–∞–µ–º —Ç–æ–∂–µ —Å–∞–º–æ–µ, –Ω–æ —É–∂–µ –Ω–µ ``` INSERT INTO ```, –∞ –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ–º, —Ç–∏–ø–∞ ``` SELECT * FROM TABLE ```. –≠—Ç–æ –∑–∞–π–º–µ—Ç –∫–æ–Ω–µ—á–Ω–æ –≤—Ä–µ–º—è, –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –æ–≥—Ä–æ–º–Ω–∞—è, –Ω–æ —ç—Ç–æ –≤—Å—è–∫–æ –ª–µ–≥—á–µ –∏ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –¥–≤–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–ø–æ—Å–æ–±–∞.



***
## –ö–ï–ô–° - –ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ Greenplum

**–ü—Ä–æ–±–ª–µ–º–∞:**

–ï—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ –≤ Greenplum. –û–Ω–∞ –º–Ω–æ–≥–æ –≤–µ—Å–∏—Ç –∏ –¥–æ–ª–≥–æ —á–∏—Ç–∞–µ—Ç—Å—è. –ù—É–∂–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–Ω–∏–º–∞–ª–∞ –º–µ—Å—Ç–æ –≤ GP, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –±—ã—Å—Ç—Ä–æ —á–∏—Ç–∞–ª–∞—Å—å. –ö–æ—Ä–æ—á–µ —É–±–∏—Ç—å –¥–≤—É—Ö –∑–∞–π—Ü–µ–≤.

**–ö–∞–∫–∏–µ –µ—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è:**

| –í–∞—Ä–∏–∞–Ω—Ç —Ä–µ—à–µ–Ω–∏—è | –ü–ª—é—Å—ã | –ú–∏–Ω—É—Å—ã |
|----------------|-------|--------|
| **–°–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ S3 —á–µ—Ä–µ–∑ PXF** | –û—Å–≤–æ–±–æ–¥–∏–º –º–µ—Å—Ç–æ –≤ Greenplum | –û—á–µ–Ω—å –¥–æ–ª–≥–æ–µ —á—Ç–µ–Ω–∏–µ |
| **–ü–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ Greenplum –ø–æ –±–∏–∑–Ω–µ—Å –¥–∞—Ç–µ** | –ë—ã—Å—Ç—Ä–æ–µ —á—Ç–µ–Ω–∏–µ | –¢–∞–±–ª–∏—Ü–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –º–µ—Å—Ç–æ + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ + –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å –∫–æ–¥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π |
| **–°–≥—Ä—É–∑–∏—Ç—å –≤ Hybrid Storage (Yezzey) –≤—Å—é —Ç–∞–±–ª–∏—Ü—É** | –≠–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞ –≤ Greenplum, —á—Ç–µ–Ω–∏–µ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º —á–µ—Ä–µ–∑ PXF | –í—Å–µ –µ—â–µ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –≤ –¥–µ—Å—è—Ç–∫–∏ —Ä–∞–∑, —á–µ–º –≤ GP |
| **–°–≥—Ä—É–∑–∏—Ç—å –≤ Yezzey —É–∂–µ –ø–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—Ü—É** | –≠–∫–æ–Ω–æ–º–∏—è –º–µ—Å—Ç–∞ –∏ –±—ã—Å—Ç—Ä–æ–µ —á—Ç–µ–Ω–∏–µ (–∫–∞–∫ –≤ GP) | –ù—É–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä—Ç–∏—Ü–∏–π –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é |

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ –¥–∞—Ç–µ (–ø–æ–ª–µ stat_date)
- –°–≥—Ä—É–∑–∏—Ç—å –≤ Yandex Hybrid Storage (Yezzey) -> [–∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥](https://github.com/open-gpdb/yezzey)
- –°–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≥–æ–¥–∞ –≤ Yezzey, –∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –≥–æ–¥ –æ—Å—Ç–∞–≤–∏—Ç—å –≤ GP


*–≠—Ç–æ—Ç Yezzey –ø–æ—Ö–æ–∂ –Ω–∞ –≤—ã–≥—Ä—É–∑–∫—É –≤ S3, –Ω–æ —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –Ω—é–∞–Ω—Å–∞–º–∏. –í–æ—Ç [—Å—Ç–∞—Ç—å—è –Ω–∞ Habr](https://habr.com/ru/companies/yandex_cloud_and_infra/articles/831780/)*

**–ö–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞—Ç—å:**

–°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏. –ù–æ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å—Ä–∞–∑—É –Ω–∞ 100 –ª–µ—Ç –≤–ø–µ—Ä–µ–¥. –í–æ-–ø–µ—Ä–≤—ã—Ö —É GP –µ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 32767 –ø–∞—Ä—Ç–∏—Ü–∏–π –Ω–∞ —Ç–∞–±–ª–∏—Ü—É. –ê –≤–æ-–≤—Ç–æ—Ä—ã—Ö –≤—ã–≥—Ä—É–∂–∞—Ç—å –≤ Yezzey —Ü–µ–ª—ã–π –≥–æ–¥ –∏ –±–æ–ª—å—à–µ –±—É–¥–µ—Ç –¥–æ–ª–≥–æ (–≤ —ç—Ç–æ –≤—Ä–µ–º—è –º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä –∏ —Ç–æ–≥–¥–∞ –≤—Å–µ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –Ω–∞—á–∏–Ω–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞). –°–æ–∑–¥–∞–ª–∏ –ø–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ–¥ –±–ª–∏–∂–∞–π—à–∏–π –º–µ—Å—è—Ü -> –∑–∞–≥—Ä—É–∑–∏–ª–∏ —Ç—É–¥–∞ –¥–∞–Ω–Ω—ã–µ -> —Å–≥—Ä—É–∑–∏–ª–∏ –≤ –≥–∏–±—Ä–∏–¥–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –ò –¥–∞–ª—å—à–µ –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏.

*–í–∞–∂–Ω–æ –∑–∞–º–µ—Ç–∏—Ç—å, —á—Ç–æ –ø–∏—Å–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –Ω–µ —Å–æ–∑–¥–∞–≤ –¥–ª—è –Ω–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π, –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è (–≤—ã–ø–∞–¥–µ—Ç –æ—à–∏–±–∫–∞). –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å default –ø–∞—Ä—Ç–∏—Ü–∏—é, –∫—É–¥–∞ –±—É–¥—É—Ç –ø–∞–¥–∞—Ç—å –¥–∞–Ω–Ω—ã–µ, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–π, –Ω–æ —Ç–æ–≥–¥–∞ –≤ —á–µ–º —Å–º—ã—Å–ª —Ä–∞–∑–±–∏–µ–Ω–∏—è –ø–æ –±–∏–∑–Ω–µ—Å –¥–∞—Ç–µ (–ª–∏–±–æ –æ—à–∏–±–∫–∞ –≤ —Å–∞–º–æ–π –±–∏–∑–Ω–µ—Å –¥–∞—Ç–µ)*

### –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—á–∫–∏

–ó–∞–º–µ—Ç—å—Ç–µ, —Å–æ–∑–¥–∞—é –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –º–µ—Å—è—Ü. –ò —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤—Å–µ –µ—â–µ –≤–Ω—É—Ç—Ä–∏ Greenplum
```sql
create table stg2.hello_world (
    stat_date date null,
    body text null,
    meta__checkpoint text null
)
with (
    appendonly = true,
    compresstype = zstd,
    compresslevel = 3,
    orientation = column
)
distributed randomly
PARTITION BY RANGE (stat_date) (
    START ('2024-01-01') INCLUSIVE
    END ('2024-02-01') EXCLUSIVE
    EVERY (INTERVAL '1 day')
);
```

### –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–∫–æ–ª—å–∫—É –º–æ—è –∏–∑–Ω–∞—á–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ –∏–º–µ–ª–∞ –º–Ω–æ–≥–æ —Ä–µ—Ç—Ä–æ –¥–∞–Ω–Ω—ã—Ö –∏ –∑–∞–Ω–∏–º–∞–ª–∞ –∫—É—á—É –º–µ—Å—Ç–∞, —è –ø—Ä–æ—á–∏—Ç–∞–ª –µ–µ –ø—Ä–∏ –ø–æ–º–æ—â–∏ Spark –∏ —Å–ª–æ–∂–∏–ª –ø–æ –ø–∞–ø–∫–∞–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ parquet –≤ –Ω–∞—à –æ–±—ã—á–Ω—ã–π S3. –≠—Ç–æ –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å –æ–±—ã—á–Ω—ã–º backup. –°–¥–µ–ª–∞–ª —ç—Ç–æ —è –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —É–∂–µ –ø–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç–∞–±–ª–∏—á–∫—É –∏–∑ S3 –∏ –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—Ç—å GP.

**–ß—Ç–µ–Ω–∏–µ –∏–∑ S3 —è –¥–µ–ª–∞–ª –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ –ø–æ –ø–∞–ø–∫–∞–º-–≥–æ–¥–∞–º-–º–µ—Å—è—Ü–∞–º —á–µ—Ä–µ–∑ PXF:**
```sql
Drop EXTERNAL TABLE if exists pxf_read_paqruet_s3_stats;
CREATE READABLE EXTERNAL TABLE pxf_read_paqruet_s3_stats (
    stat_date date null,
    body text null,
    meta__checkpoint text null
)
LOCATION ('pxf://data-lake/hello_world/year=2024/partition_date=2024-01-*/?PROFILE=s3:parquet&accesskey=***&secretkey=***&endpoint=https://storage.yandexcloud.net')
FORMAT 'CUSTOM' (FORMATTER='pxfwritable_import');

select *
from pxf_read_paqruet_s3;

insert into stg2.hello_world
select * from pxf_read_paqruet_s3_stats;
```

### –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Yezzey
–ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ —è –∑–∞–≥—Ä—É–∂–∞–ª –¥–∞–Ω–Ω—ã–µ –∑–∞ –º–µ—Å—è—Ü, –æ–Ω–∏ —Å–≥—Ä—É–∂–∞–ª–∏—Å—å –≤ Hybrid Storage. –Ø –¥–µ–ª–∞–ª —ç—Ç–æ –ø–æ 1-3 –º–µ—Å—è—Ü–∞ –∑–∞ —Ä–∞–∑, –Ω–æ –Ω–µ –±–æ–ª–µ–µ.
```sql
SELECT yezzey_define_offload_policy('stg2', 'hello_world');
```

### –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä—Ç—Ü–∏–∏–π

–≠—Ç–æ –æ–±—ã—á–Ω—ã–π —Ü–∏–∫–ª, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã. –£—Å–ª–æ–≤–Ω–æ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –º–µ—Å—Ç–æ, –∫—É–¥–∞ –±—É–¥—É—Ç –ª–∏—Ç—å—Å—è –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.
```sql
-- –°–æ–∑–¥–∞—Ç—å –ø–∞—Ä—Ç–∏—Ü–∏–∏ –æ—Ç –í–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û –¥–æ –ù–ï–í–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û
DO $$ 
DECLARE 
    partition_start DATE := '2024-02-01';
    partition_end DATE := '2024-03-01';
    next_day DATE;
BEGIN
    WHILE partition_start < partition_end LOOP
        next_day := partition_start + INTERVAL '1 day';
        
        EXECUTE format(
            'ALTER TABLE stg2.hello_world 
            ADD PARTITION START (''%s'') END (''%s'');', 
            partition_start, next_day
        );
        partition_start := next_day;
    END LOOP;
END $$;
```

–ò—Ç–æ–≥–æ, —è –∑–∞–≥—Ä—É–∑–∏–ª —Ç–∞–±–ª–∏—Ü—É –≤ –≥–∏–±—Ä–∏–¥–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Ç 2020 –¥–æ 2024 –≥–æ–¥–∞ –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ, –∞ —Ç–µ–∫—É—â–∏–π 2025 –≥–æ–¥ –æ—Å—Ç–∞–≤–∏–ª –≤–Ω—É—Ç—Ä–∏ Greenplum. –¢–∞–±–ª–∏—Ü–∞ –ø–∞—Ä—Ç–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ –¥–Ω—è–º. –°–µ–π—á–∞—Å –æ–±—â–µ–µ –∫–æ–ª-–≤–æ –ø–∞—Ä—Ç–∏—Ü–∏–π –ø–æ–¥ 1800. –û—á–µ–≤–∏–¥–Ω–æ, —á—Ç–æ –ø—Ä–µ–¥–µ–ª –≤ 32767 –ø–∞—Ä—Ç–∏—Ü–∏–π —è –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É - —ç—Ç–æ –ø–æ—á—Ç–∏ 90 –ª–µ—Ç. –ù–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ–∫ –±—É–¥–µ—Ç greenplum —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏. –° –∫–∞–∂–¥—ã–º –¥–Ω–µ–º –∏—Ö –±—É–¥–µ—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤—Å–µ –±–æ–ª—å—à–µ. 


### –í—ã–≤–æ–¥—ã
–ù–∏–∂–µ —è –ø—Ä–∏–≤–µ–ª –ø—Ä–∏–º–µ—Ä –∏ –ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ –∫–µ–π—Å–æ–≤:

### SQL –∑–∞–ø—Ä–æ—Å
```sql
explain analyze
select count(1)
from stg2.hello_world
where stat_date = '2025-02-10';
```

| **–•—Ä–∞–Ω–∏–ª–∏—â–µ** | **–ü–∞—Ä—Ç–∏—Ü–∏–∏**  | **Cost**                   | **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**  |
|-------------------------|--------------|---------------------------|------------------|
| **GP**                 | –ü–æ –¥–Ω—é       | 168.03..168.04           | 1.08 —Å–µ–∫        |
| **Yezzey**             | –ü–æ –¥–Ω—é       | 56640.78..56640.79       | 4.47 —Å–µ–∫        |
| **Yezzey**             | –ë–µ–∑ –ø–∞—Ä—Ç–∏—Ü–∏–π | 64656610.72..64656610.73 | **3 –º–∏–Ω 29 —Å–µ–∫** |
| **PXF S3**             | –ë–µ–∑ –ø–∞—Ä—Ç–∏—Ü–∏–π | 13503.01..13503.02       | **5 –º–∏–Ω 38 —Å–µ–∫** |

### –í—ã–≤–æ–¥—ã:
- **GP —Å –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ –ø–æ –¥–Ω—é** ‚Äì —Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (1.08 —Å–µ–∫) —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º cost (168).  
- **Yezzey —Å –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏** –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ 4.47 —Å–µ–∫, —á—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –±–µ–∑ –ø–∞—Ä—Ç–∏—Ü–∏–π.  
- **Yezzey –±–µ–∑ –ø–∞—Ä—Ç–∏—Ü–∏–π** –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–≤ 47 —Ä–∞–∑ –¥–æ–ª—å—à–µ**, —á–µ–º —Å –ø–∞—Ä—Ç–∏—Ü–∏—è–º–∏ (3 –º–∏–Ω 29 —Å–µ–∫ –ø—Ä–æ—Ç–∏–≤ 4.47 —Å–µ–∫).  
- **PXF S3 –±–µ–∑ –ø–∞—Ä—Ç–∏—Ü–∏–π** ‚Äì —Å–∞–º—ã–π –º–µ–¥–ª–µ–Ω–Ω—ã–π (5 –º–∏–Ω 38 —Å–µ–∫).

 
### –ù–∏–∂–µ –ø—Ä–∏–≤–æ–∂—É –ø–ª–∞–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–∑ –∫–µ–π—Å–æ–≤:

- –ü–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –¥–Ω—é (Greenplum)
```sql
Aggregate  (cost=168.03..168.04 rows=1 width=8) (actual time=730.806..730.807 rows=1 loops=1)
  ->  Gather Motion 48:1  (slice1; segments: 48)  (cost=167.51..168.01 rows=1 width=8) (actual time=39.514..730.637 rows=48 loops=1)
        ->  Aggregate  (cost=167.51..167.52 rows=1 width=8) (actual time=328.150..328.150 rows=1 loops=1)
              ->  Append  (cost=0.00..167.50 rows=1 width=0) (actual time=0.089..345.690 rows=64948 loops=1)
                    ->  Seq Scan on hello_world_1_prt_r287043979  (cost=0.00..167.50 rows=1 width=0) (actual time=0.088..218.898 rows=64948 loops=1)
                          Filter: (stat_date = '2025-02-10'::date)
Planning time: 2996.883 ms
  (slice0)    Executor memory: 4918K bytes.
  (slice1)    Executor memory: 234K bytes avg x 48 workers, 234K bytes max (seg0).
Memory used:  24576kB
Optimizer: Postgres query optimizer
Execution time: 1082.391 ms
```

- –ü–∞—Ä—Ç–∏—Ü–∏–∏ –ø–æ –¥–Ω—é (Yezzey)
```sql
Aggregate  (cost=56640.78..56640.79 rows=1 width=8) (actual time=4293.035..4293.035 rows=1 loops=1)
  ->  Gather Motion 48:1  (slice1; segments: 48)  (cost=56640.26..56640.76 rows=1 width=8) (actual time=977.990..4292.599 rows=48 loops=1)
        ->  Aggregate  (cost=56640.26..56640.28 rows=1 width=8) (actual time=1033.459..1033.460 rows=1 loops=1)
              ->  Append  (cost=0.00..50203.89 rows=53637 width=0) (actual time=1280.037..1334.369 rows=54148 loops=1)
                    ->  Seq Scan on hello_world_1_prt_r798590680  (cost=0.00..50203.89 rows=53637 width=0) (actual time=1280.037..1326.521 rows=54148 loops=1)
                          Filter: (stat_date = '2024-02-10'::date)
Planning time: 2388.470 ms
  (slice0)    Executor memory: 4918K bytes.
  (slice1)    Executor memory: 234K bytes avg x 48 workers, 234K bytes max (seg0).
Memory used:  24576kB
Optimizer: Postgres query optimizer
Execution time: 4467.812 ms
```

- –ù–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–π (Yezzey)
```sql
Aggregate  (cost=64656610.72..64656610.73 rows=1 width=8) (actual time=209189.974..209189.974 rows=1 loops=1)
  ->  Gather Motion 48:1  (slice1; segments: 48)  (cost=64656610.21..64656610.71 rows=1 width=8) (actual time=77770.652..209189.813 rows=48 loops=1)
        ->  Aggregate  (cost=64656610.21..64656610.22 rows=1 width=8) (actual time=135874.293..135874.293 rows=1 loops=1)
              ->  Seq Scan on hello_world_old  (cost=0.00..64651431.80 rows=43154 width=0) (actual time=694.990..82860.795 rows=54016 loops=1)
                    Filter: (stat_date = '2024-02-10'::text)
Planning time: 1.600 ms
  (slice0)    Executor memory: 266K bytes.
  (slice1)    Executor memory: 322K bytes avg x 48 workers, 322K bytes max (seg0).
Memory used:  24576kB
Optimizer: Postgres query optimizer
Execution time: 209223.460 ms
```

- –ù–µ—Ç –ø–∞—Ä—Ç–∏—Ü–∏–π (PXF S3)
```sql
Aggregate  (cost=13503.01..13503.02 rows=1 width=8) (actual time=338455.033..338455.033 rows=1 loops=1)
  ->  Gather Motion 48:1  (slice1; segments: 48)  (cost=13502.50..13503.00 rows=1 width=8) (actual time=250234.310..338454.862 rows=48 loops=1)
        ->  Aggregate  (cost=13502.50..13502.51 rows=1 width=8) (actual time=297374.062..297374.062 rows=1 loops=1)
              ->  External Scan on pxf_read_paqruet_s3_stats  (cost=0.00..13500.00 rows=21 width=0) (actual time=257059.696..306274.212 rows=159778 loops=1)
                    Filter: (stat_date = '2024-02-10'::date)
Planning time: 0.260 ms
  (slice0)    Executor memory: 239K bytes.
  (slice1)    Executor memory: 220K bytes avg x 48 workers, 266K bytes max (seg19).
Memory used:  24576kB
Optimizer: Postgres query optimizer
Execution time: 338458.499 ms
```
***

## –ö–ï–ô–° - –ö–∞–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø–æ–¥–≤–∏—Å—à–∏–µ —Å–µ–Ω—Å–æ—Ä—ã?

**–ö–µ–π—Å –≤–∑—è—Ç —É [–ê–π–≥—É–ª—å (–ö–∞–Ω–∞–ª –¥–∞—Ç–∞ –∏–Ω–∂–µ–Ω–µ—Ä–µ—Ç—Ç–∞)](https://t.me/data_engineerette)**

–ù–∞—á–Ω–µ–º —Å —Ç–æ–≥–æ, —á—Ç–æ –≤ Airflow –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–ª—è —Ç–∞—Å–∫–∏:

| –≠–º–æ–¥–∑–∏ | –°—Ç–∞—Ç—É—Å             | –û–ø–∏—Å–∞–Ω–∏–µ                                                 |
|--------|---------------------|-------------------------------------------------------------|
| üîµ     | none                | –ø–æ–∫–∞ –æ—Ç–¥—ã—Ö–∞–µ—Ç                                               |
| üü°     | scheduled           | –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–∞, –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã            |
| ‚ö™     | queued              | –∂–¥–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã–π –≤–æ—Ä–∫–µ—Ä                                       |
| üü¢     | running             | —Ä–∞–±–æ—Ç–∞–µ—Ç                                                     |
| ‚úÖ     | success             | —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å                                          |
| üå∏     | restarting          | –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª–∏                                                |
| üî¥     | failed               | —É–ø–∞–ª–∞                                                         |
| üö´     | skipped             | –ø—Ä–æ–ø—É—â–µ–Ω–∞                                                    |
| üîª     | upstream_failed     | —É–ø–∞–ª–∞ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ç–∞—Å–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–º –Ω—É–∂–Ω–∞                     |
| üîÑ     | up_for_retry         | —É–ø–∞–ª–∞, –Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞                                 |
| üîÇ     | up_for_reschedule    | —Å–µ–Ω—Å–æ—Ä –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω                                     |
| ‚è∏     | deferred            | –æ—Ç–ª–æ–∂–µ–Ω–∞ –∏ –∂–¥–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä                                       |
| ‚ùå     | removed             | —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –¥–∞–≥–∞ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞                                |

---
–ü–æ–¥–≤–∏—Å—à–∏–µ —Å–µ–Ω—Å–æ—Ä—ã —É—Ö–æ–¥—è—Ç –≤ —Å—Ç–∞—Ç—É—Å deferred.
–£ –Ω–∞—Å –æ–Ω–∏ –∏–º–µ—é—Ç —Ç–∞–∫–æ–π –Ω–µ–π–º–∏–Ω–≥ - mytask_awaiting_somedag.
–Ø –Ω–∞–ø–∏—Å–∞–ª–∞ —Å–µ–±–µ –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–≤–æ–¥–∏—Ç:

‚≠ïÔ∏è –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∞–≥–∞, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π —Å–º–æ—Ç—Ä–∏—Ç —Å–µ–Ω—Å–æ—Ä

‚≠ïÔ∏è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–Ω—Å–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∂–¥—É—Ç —ç—Ç–æ—Ç –¥–∞–≥

‚≠ïÔ∏è –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–≤–∏—Å—à–∏—Ö —Å–µ–Ω—Å–æ—Ä–æ–≤

–ò —Ç–∞–∫ –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –ø–æ–Ω—è—Ç—å, –Ω–∞ –∫–∞–∫–æ–π –¥–∞–≥ —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞–∏–±–æ–ª—å—à–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–Ω—Å–æ—Ä–æ–≤, –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏—á–∏–Ω—É


```sql
with sensored as (
  SELECT 
    substr(
      task_id,
      strpos(task_id, 'awaiting_') + length('awaiting_')
    ) as sensor,
    dag_id
  FROM airflow.public.task_instance
  WHERE state = 'deferred'
)
select
  sensor,
  count(1) over(partition by sensor) as sensor_cnt,
  count(1) over() as total_cnt,
  dag_id
from sensored
order by 2 desc, sensor, dag_id;
```
